#define F_CPU 16000000UL  // 16 MHz
#include <avr/io.h>
#include <util/delay.h>
#include <stdint.h>


int counter; 
uint16_t result;
uint8_t input;
int current_index = 6;
 
unsigned const int OCR_table[13] = {5, 25, 46, 66, 86, 107, 128, 148, 168, 188, 209, 229, 250};

int main(void){  
    
    DDRB = 0xFF;        //PORTB outputs 
    DDRD = 0x9F;        //5 first bits as output and the PD7 (last)
    PORTB = 0x00;
    PORTD = 0x00;
    
    //set up
    TCCR1B = 0x0C;
    TCCR1A = 0x81;
    
    //TCCR1A = (1 << WGM10) | (1 << COM1A1);
    //TCCR1B = (1 << CS10) | (1 << WGM12);
    

    //ADC initialize
    ADMUX = (1 << REFS0) | (1 << MUX0);
    ADCSRA = (1 << ADEN) | (1 << ADPS2) | (1 << ADPS1) | (1 << ADPS0);     
 
    while(1){
        counter = 0;
        result = 0x00;
        while (counter!=16){
            input = ~PIND;
            input = (input & 0x60);
            
            OCR1AL = OCR_table[current_index];

            if(input == 0x60) continue;
            else if ((input == 0x20) && (current_index != 0)) { //lower if pd5
                current_index--;
                //PORTC = OCR_table[current_index];
                OCR1AL = OCR_table[current_index];
            }
            else if ((input == 0x40) && (current_index != 12)){ //higher if pd6 is pressed
                current_index++;
                //PORTC = OCR_table[current_index];
                OCR1AL = OCR_table[current_index];
            }
                      
            _delay_ms(100);
                
            ADCSRA |= 0x40; //start adc
            while((ADCSRA&0x40)!= 0x00){}  //while ?he conversion last hold fast
            result = result + ADC;
            
            counter++;
        }
        
        result = (result >> 4);
        
        if (result >= 0 && result <= 200) PORTD = 0x01;
        else if ((result>=200) && (result <= 400)) PORTD = 0x02;
        else if (result <= 600) PORTD = 0x04;
        else if (result <= 800) PORTD = 0x08;
        else PORTD = 0x10;    
        
       
        
    
    
    }
    




}